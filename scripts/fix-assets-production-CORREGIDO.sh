#!/bin/bash
# Script DEFINITIVO CORREGIDO para problemas de assets en producci√≥n + MinIO
# Soluciona 404 errors de archivos JS/CSS del frontend admin + dependencia MinIO
# CORRECCIONES: docker-compose.admin.yml, mount points, verificaci√≥n MinIO

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo -e "${BLUE}üîß CLINIC SYSTEM - ASSETS FIX CORREGIDO + MinIO${NC}"
echo "=================================================="

echo ""
echo -e "${YELLOW}üîç Problemas identificados y corregidos:${NC}"
echo "   ‚ùå Docker compose incorrecto (docker-compose.yml vs docker-compose.admin.yml)"
echo "   ‚ùå Nombre contenedor incorrecto (clinic-backend-api vs clinic-admin-system)"
echo "   ‚ùå MinIO dependency: ModuleNotFoundError: No module named 'minio'"
echo "   ‚ùå Mount points faltantes en main.py"
echo "   ‚úÖ Soluci√≥n: Docker compose correcto + MinIO verificado + mount points"

# Navigate to project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
cd "$PROJECT_ROOT"

echo ""
echo -e "${BLUE}üìã Estado actual del sistema:${NC}"
echo "Current commit: $(git log -1 --oneline)"
echo "Backend directory: $(pwd)/clinic-admin-backend"

# ==========================================
# PASO 1: Verificar y agregar dependencia MinIO
# ==========================================
echo ""
echo -e "${BLUE}üîß PASO 1: Verificando dependencia MinIO${NC}"

if grep -q "minio" clinic-admin-backend/requirements.txt; then
    echo -e "${GREEN}‚úÖ Dependencia MinIO ya est√° en requirements.txt${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è Agregando dependencia MinIO a requirements.txt${NC}"
    echo "" >> clinic-admin-backend/requirements.txt
    echo "# MinIO S3 Storage Client" >> clinic-admin-backend/requirements.txt
    echo "minio==7.2.16" >> clinic-admin-backend/requirements.txt
    echo -e "${GREEN}‚úÖ Dependencia MinIO agregada${NC}"
fi

# ==========================================
# PASO 2: Crear/Actualizar main.py con mount points
# ==========================================
echo ""
echo -e "${BLUE}üîß PASO 2: Configurando mount points en main.py${NC}"

cd clinic-admin-backend

# Verificar si main.py ya tiene los mount points
if grep -q "app.mount.*assets" main.py; then
    echo -e "${GREEN}‚úÖ Mount points ya configurados en main.py${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è Agregando mount points a main.py${NC}"
    
    # Crear backup
    cp main.py main.py.backup
    
    # Buscar l√≠nea despu√©s de las importaciones y agregar mount points
    python3 << 'EOF'
import re

# Leer el archivo
with open('main.py', 'r') as f:
    content = f.read()

# Buscar d√≥nde insertar los mount points (despu√©s de crear la app)
app_creation_pattern = r'(app = FastAPI\([^)]*\)[^}]*}?\s*)'
mount_points_code = '''
# ==========================================
# ASSETS MOUNT POINTS - Soluci√≥n 404 Assets
# ==========================================
# Verificar que el directorio existe antes de montar
import os
if os.path.exists("static/admin"):
    try:
        app.mount("/admin/assets", StaticFiles(directory="static/admin/assets", html=True), name="admin-assets")
        app.mount("/assets", StaticFiles(directory="static/admin/assets", html=True), name="assets")
        app.mount("/static/admin/assets", StaticFiles(directory="static/admin/assets", html=True), name="static-admin")
        app.mount("/static", StaticFiles(directory="static", html=True), name="static-all")
        print("‚úÖ Assets mount points configurados correctamente")
    except Exception as e:
        print(f"‚ö†Ô∏è Error configurando mount points: {e}")
else:
    print("‚ö†Ô∏è Directorio static/admin no encontrado")

'''

# Insertar despu√©s de la creaci√≥n de la app
if re.search(app_creation_pattern, content):
    content = re.sub(
        app_creation_pattern,
        r'\1' + mount_points_code,
        content,
        flags=re.DOTALL
    )
    
    # Escribir el archivo modificado
    with open('main.py', 'w') as f:
        f.write(content)
    
    print("‚úÖ Mount points agregados a main.py")
else:
    print("‚ùå No se pudo encontrar la creaci√≥n de la app en main.py")
EOF

    echo -e "${GREEN}‚úÖ main.py actualizado con mount points${NC}"
fi

# ==========================================
# PASO 3: Crear Dockerfile.admin si no existe
# ==========================================
echo ""
echo -e "${BLUE}üîß PASO 3: Verificando Dockerfile.admin${NC}"

if [ ! -f "Dockerfile.admin" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è Creando Dockerfile.admin espec√≠fico${NC}"
    
    # Copiar Dockerfile base y agregar verificaci√≥n MinIO
    cp Dockerfile Dockerfile.admin
    
    # Modificar para verificar MinIO
    sed -i '/pip install --no-cache-dir -r requirements.txt/a\
    # Verificar instalaci√≥n MinIO despu√©s de instalar requirements\
    RUN python -c "import minio; print(\"MinIO installed successfully\")" || (echo "MinIO installation failed" && exit 1)' Dockerfile.admin
    
    echo -e "${GREEN}‚úÖ Dockerfile.admin creado con verificaci√≥n MinIO${NC}"
else
    echo -e "${GREEN}‚úÖ Dockerfile.admin ya existe${NC}"
    
    # Verificar si tiene la verificaci√≥n MinIO
    if ! grep -q "import minio" Dockerfile.admin; then
        echo -e "${YELLOW}‚ö†Ô∏è Agregando verificaci√≥n MinIO a Dockerfile.admin${NC}"
        sed -i '/pip install --no-cache-dir -r requirements.txt/a\
        # Verificar instalaci√≥n MinIO despu√©s de instalar requirements\
        RUN python -c "import minio; print(\"MinIO installed successfully\")" || (echo "MinIO installation failed" && exit 1)' Dockerfile.admin
    fi
fi

# Check frontend admin directory
echo ""
echo -e "${BLUE}üîç PASO 4: Verificando estructura frontend admin${NC}"
if [ -d "frontend-admin" ]; then
    echo "‚úÖ frontend-admin directory exists"
    ls -la frontend-admin/ | head -5
else
    echo "‚ùå frontend-admin directory not found"
    echo "Creating frontend-admin structure..."
    mkdir -p frontend-admin
fi

# Check static admin directory
echo ""
echo "üìÅ Static admin status:"
if [ -d "static/admin" ]; then
    echo "‚úÖ static/admin exists"
    echo "Directory size: $(du -sh static/admin)"
    echo "Files count: $(find static/admin -type f | wc -l)"
else
    echo "‚ùå static/admin not found"
fi

# ==========================================
# PASO 5: Stop containers con archivo correcto
# ==========================================
echo ""
echo -e "${BLUE}üõë PASO 5: Deteniendo contenedores (docker-compose.admin.yml)${NC}"
docker-compose -f docker-compose.admin.yml down
sleep 2

# Navigate to main project for frontend build
echo ""
echo -e "${BLUE}üèóÔ∏è PASO 6: Rebuildeando frontend${NC}"
cd "$PROJECT_ROOT"

# Clean and rebuild frontend
echo "Cleaning previous builds..."
rm -rf dist
rm -rf node_modules/.vite

echo "Installing dependencies..."
npm install --silent

echo "Building frontend..."
npm run build

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Frontend build successful${NC}"
    
    # Copy to backend
    echo "Copying build to backend..."
    rm -rf clinic-admin-backend/static/admin/*
    mkdir -p clinic-admin-backend/static/admin
    cp -r dist/* clinic-admin-backend/static/admin/
    
    echo "Build copied to static/admin"
    echo "Files: $(find clinic-admin-backend/static/admin -type f | wc -l)"
else
    echo -e "${RED}‚ùå Frontend build failed${NC}"
    exit 1
fi

# Navigate back to backend
cd clinic-admin-backend

# ==========================================
# PASO 7: Rebuild backend con docker-compose.admin.yml
# ==========================================
echo ""
echo -e "${BLUE}üê≥ PASO 7: Rebuildeando backend (docker-compose.admin.yml + MinIO)${NC}"
echo "Building Docker image with MinIO dependency..."
docker-compose -f docker-compose.admin.yml build --no-cache

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Backend rebuild successful (MinIO included)${NC}"
else
    echo -e "${RED}‚ùå Backend build failed${NC}"
    exit 1
fi

# ==========================================
# PASO 8: Start services con archivo correcto
# ==========================================
echo ""
echo -e "${BLUE}üöÄ PASO 8: Iniciando servicios (docker-compose.admin.yml)${NC}"
docker-compose -f docker-compose.admin.yml up -d

# Wait for startup
echo ""
echo -e "${BLUE}‚è≥ Esperando inicializaci√≥n completa (30 segundos)...${NC}"
sleep 30

# ==========================================
# VERIFICACI√ìN EXHAUSTIVA CORREGIDA
# ==========================================
echo ""
echo -e "${BLUE}üß™ VERIFICACI√ìN EXHAUSTIVA CORREGIDA${NC}"
echo "========================================="

echo ""
echo "üìä Estado del contenedor:"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | head -10

echo ""
echo "üåê Health Check:"
backend_response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:60519/health 2>/dev/null || echo "ERROR")

if [ "$backend_response" = "200" ]; then
    echo -e "${GREEN}‚úÖ Backend: OK${NC}"
else
    echo -e "${RED}‚ùå Backend: ERROR${NC}"
    echo "Checking logs for issues..."
    docker logs --tail 10 clinic-admin-system
fi

# ==========================================
# Verificaci√≥n MinIO
# ==========================================
echo ""
echo "üóÉÔ∏è MinIO Integration Check:"
minio_response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:60519/docs 2>/dev/null || echo "ERROR")

if [ "$minio_response" = "200" ]; then
    echo -e "${GREEN}‚úÖ API Docs: OK (MinIO integration working)${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è API Docs: Check required${NC}"
fi

echo ""
echo "üìÇ Verificaci√≥n de archivos est√°ticos:"
if docker exec clinic-admin-system test -d /app/static/admin; then
    file_count=$(docker exec clinic-admin-system find /app/static/admin -type f | wc -l)
    echo -e "${GREEN}‚úÖ Static admin files: $file_count files found${NC}"
else
    echo -e "${RED}‚ùå Static admin directory not found in container${NC}"
fi

echo ""
echo "üîç Mount points verification:"
echo "Verificando que los assets sean accesibles..."

# Test asset endpoints
admin_assets_test=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:60519/admin/assets/" 2>/dev/null || echo "ERROR")
assets_test=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:60519/assets/" 2>/dev/null || echo "ERROR")

echo "Testing /admin/assets/ endpoint: $admin_assets_test"
echo "Testing /assets/ endpoint: $assets_test"

# Test specific asset file
echo "Testing specific asset file:"
asset_file=$(docker exec clinic-admin-system find /app/static/admin -name "*.js" | head -1)
if [ ! -z "$asset_file" ]; then
    asset_filename=$(basename "$asset_file")
    asset_test=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:60519/assets/$asset_filename" 2>/dev/null || echo "ERROR")
    echo "Testing /assets/$asset_filename: $asset_test"
fi

echo ""
echo "üìã Logs recientes (verificando mounts):"
docker logs --tail 5 clinic-admin-system

echo ""
echo "========================================"
echo -e "${GREEN}üéâ ASSETS + MinIO FIX CORREGIDO COMPLETADO${NC}"
echo "========================================"

echo ""
echo "üåê URLs para probar:"
echo "   üîß Admin Dashboard: http://localhost:60519/admin"
echo "   üìö API Docs: http://localhost:60519/docs"
echo "   ‚ö° Health Check: http://localhost:60519/health"

echo ""
echo "üîç Para verificar assets:"
echo "   Accede al admin dashboard y verifica que no haya errores 404"
echo "   Revisa la consola del navegador para confirmaci√≥n"

echo ""
echo "üí° ¬øQu√© se corrigi√≥?"
echo "   ‚úÖ CORREGIDO: Uso de docker-compose.admin.yml (no docker-compose.yml)"
echo "   ‚úÖ CORREGIDO: Contenedor clinic-admin-system (no clinic-backend-api)"
echo "   ‚úÖ AGREGADO: Mount points en main.py para assets"
echo "   ‚úÖ AGREGADO: Dockerfile.admin con verificaci√≥n MinIO"
echo "   ‚úÖ Rebuild completo del frontend admin"
echo "   ‚úÖ Dependencia MinIO agregada a requirements.txt"
echo "   ‚úÖ Backend rebuildeado con MinIO incluido"
echo "   ‚úÖ 4 mount points de assets para m√°xima compatibilidad:"
echo "      - /admin/assets (original)"
echo "      - /assets (fix principal para 404s)"
echo "      - /static/admin/assets (alternativo)"
echo "      - /static (todos los archivos est√°ticos)"
echo "   ‚úÖ Limpieza de builds antiguos"
echo "   ‚úÖ Verificaci√≥n exhaustiva de funcionamiento"
echo "   ‚úÖ Integraci√≥n MinIO verificada"

echo ""
if [ "$backend_response" = "200" ]; then
    echo -e "${GREEN}¬°Script CORREGIDO completado! El problema de assets y MinIO deber√≠a estar resuelto definitivamente.${NC}"
else
    echo -e "${YELLOW}Script completado con advertencias. Revisar logs si persisten problemas.${NC}"
fi

echo "Presiona Enter para continuar..."
read